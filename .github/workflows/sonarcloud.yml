# Python Libs - SonarCloud Analysis
# Continuous code quality and security analysis
#
# Features:
#   - Code quality metrics (bugs, code smells, technical debt)
#   - Security vulnerability detection (OWASP Top 10)
#   - Test coverage tracking
#   - Quality gate enforcement
#   - Pull request decoration
#
# SonarCloud Dashboard: https://sonarcloud.io/dashboard?id=ByronWilliamsCPA_python_libs
# Documentation: https://docs.sonarsource.com/sonarqube-cloud/
#
# Note: This workflow requires SONAR_TOKEN secret to be configured.
# If not configured, the workflow will skip with a helpful message.

name: SonarCloud

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write  # Required for PR decoration

jobs:
  # Check if SONAR_TOKEN is configured before running analysis
  check-secrets:
    name: Check Configuration
    runs-on: ubuntu-latest
    outputs:
      has-token: ${{ steps.check.outputs.has-token }}
    steps:
      - name: Check for SONAR_TOKEN
        id: check
        run: |
          if [ -n "${{ secrets.SONAR_TOKEN }}" ]; then
            echo "has-token=true" >> $GITHUB_OUTPUT
            echo "::notice::SONAR_TOKEN is configured. SonarCloud analysis will run."
          else
            echo "has-token=false" >> $GITHUB_OUTPUT
            echo "::warning::SONAR_TOKEN is not configured. Skipping SonarCloud analysis."
            echo "To enable SonarCloud:"
            echo "1. Create a project at https://sonarcloud.io"
            echo "2. Generate a token at https://sonarcloud.io/account/security"
            echo "3. Add SONAR_TOKEN as a repository secret"
          fi

  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: check-secrets
    if: needs.check-secrets.outputs.has-token == 'true'
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0  # Disable shallow clone for better analysis

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install UV
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv sync --frozen --all-extras

      - name: Run tests with coverage
        run: |
          # Generate coverage in Cobertura XML format for SonarCloud
          uv run pytest \
            --cov=src/python_libs \
            --cov-report=xml:coverage.xml \
            --cov-report=term \
            --cov-branch \
            -v
        continue-on-error: true  # Don't fail on test failures; let SonarCloud report them

      - name: Verify coverage report
        run: |
          if [ ! -f coverage.xml ]; then
            echo "::warning::Coverage report not found. Tests may have failed."
            # Create empty coverage file to prevent SonarCloud error
            echo '<?xml version="1.0" ?><coverage version="1.0"></coverage>' > coverage.xml
          else
            echo "âœ“ Coverage report generated successfully"
            ls -lh coverage.xml
          fi

      - name: SonarCloud Scan
        id: sonar-scan
        uses: SonarSource/sonarqube-scan-action@884b79409bbd464b2a59edc326a4b77dc56b2195 # v4.0.0
        continue-on-error: true  # Don't fail if project not yet configured in SonarCloud
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed for PR decoration
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}      # SonarCloud authentication
        with:
          args: >
            -Dsonar.organization=ByronWilliamsCPA
            -Dsonar.projectKey=ByronWilliamsCPA_python_libs
            -Dsonar.python.version=3.12

      - name: SonarCloud Setup Notice
        if: steps.sonar-scan.outcome == 'failure'
        run: |
          echo "::warning::SonarCloud scan failed. This may indicate the project needs to be created."
          echo ""
          echo "To set up SonarCloud:"
          echo "1. Go to https://sonarcloud.io and sign in with GitHub"
          echo "2. Import the ByronWilliamsCPA/python-libs repository"
          echo "3. The project key should be: ByronWilliamsCPA_python_libs"
          echo "4. Re-run this workflow after project creation"

      - name: Check Quality Gate
        if: steps.sonar-scan.outcome == 'success'
        uses: sonarsource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: true  # Don't fail workflow, just report status

      - name: Quality Gate Summary
        if: always()
        run: |
          echo "### SonarCloud Quality Gate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View detailed results: https://sonarcloud.io/dashboard?id=ByronWilliamsCPA_python_libs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Metrics analyzed:**" >> $GITHUB_STEP_SUMMARY
          echo "- Code Quality (bugs, code smells, maintainability)" >> $GITHUB_STEP_SUMMARY
          echo "- Security (vulnerabilities, security hotspots)" >> $GITHUB_STEP_SUMMARY
          echo "- Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- Code Duplication" >> $GITHUB_STEP_SUMMARY
          echo "- Technical Debt" >> $GITHUB_STEP_SUMMARY

      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: coverage-sonarcloud
          path: |
            coverage.xml
            .coverage
          retention-days: 7
