# PR Validation for Python Libs
# Pull request validation using supplemental checks workflow.
#
# Uses reusable workflow from: ByronWilliamsCPA/.github
#
# Note: Core CI checks (tests, linting, type checking) are handled by ci.yml.
# This workflow provides additional PR-specific validations.
name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - master
      - develop

# Cancel in-progress runs for same PR
concurrency:
  group: pr-validation-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  # ==========================================================================
  # Supplemental PR Checks (Changelog, Link Validation)
  # ==========================================================================
  supplemental-checks:
    uses: ByronWilliamsCPA/.github/.github/workflows/python-supplemental-checks.yml@main
    with:
      # Changelog enforcement
      enable-changelog-check: true
      changelog-path: 'CHANGELOG.md'
      changelog-skip-labels: 'skip-changelog,dependencies,documentation'

      # Documentation link validation
      enable-link-check: true
      link-check-paths: './docs/**/*.md ./README.md ./CONTRIBUTING.md'
      link-check-fail: false

      # Cruft template sync (already handled by validate-cruft.yml, so skip here)
      enable-cruft-check: false

      # Dependency auto-merge (handled separately)
      enable-automerge: false
    secrets: inherit

  # ==========================================================================
  # Dead Code Detection (not in supplemental-checks, keep inline)
  # ==========================================================================
  dead-code:
    name: Dead Code Check
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install UV
        uses: astral-sh/setup-uv@6b9c6063abd6010835644d4c2e1bef4cf5cd0fca # v6.0.1
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run vulture
        run: |
          echo "## Dead Code Report" >> $GITHUB_STEP_SUMMARY
          uv run vulture src/ packages/ --min-confidence 90 | tee vulture-report.txt || true
          if [ -s vulture-report.txt ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat vulture-report.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "::warning::Potential dead code detected. Review vulture report."
          else
            echo "âœ… No dead code detected with 90% confidence." >> $GITHUB_STEP_SUMMARY
          fi
